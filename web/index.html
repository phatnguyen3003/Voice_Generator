<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Edge-TTS AI Generator Studio</title>
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="/eel.js"></script>
    <script src="bootstrap.bundle.min.js"></script>
    <style>
        .main-background {
            background-color: #f0f2f5;
        }

        .background-blue {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .sticky-preview {
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .form-range::-webkit-slider-thumb {
            background: #0d6efd;
        }

        .fx-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }

        .label-value {
            color: #0d6efd;
            font-weight: bold;
        }

        .playing-now {
            border: 2px solid #198754 !important;
            background-color: #e8f5e9 !important;
            transition: 0.3s;
        }

        /* Th√™m style cho Preset Badges */
        .preset-badge {
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.8rem;
            border: 1px solid transparent;
        }

        .preset-badge:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .fx-details {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-top: 10px;
        }

        .btn-edit-fx {
            font-size: 10px;
            padding: 2px 8px;
        }

        /* Sidebar c·ªë ƒë·ªãnh */
        .custom-sidebar {
            width: 240px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #212529;
            color: white;
            padding-top: 20px;
            z-index: 1000;
            border-right: 1px solid #343a40;
        }

        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            color: #adb5bd;
            text-decoration: none;
        }

        .sidebar-item:hover,
        .sidebar-item.active {
            background-color: #0d6efd;
            color: white;
        }

        .sidebar-item i {
            width: 25px;
            margin-right: 10px;
        }

        /* ƒê·∫©y n·ªôi dung ch√≠nh sang ph·∫£i 240px */
        .main-wrapper {
            margin-left: 240px;
            padding: 20px;
            width: calc(100% - 240px);
        }

        /* ·∫®n c√°c section khi ch∆∞a ch·ªçn */
        .app-page {
            display: none;
        }

        .app-page.active {
            display: block;
        }

        /* CSS c·∫≠p nh·∫≠t ƒë·ªÉ h·ªó tr·ª£ cu·ªôn */
        .app-page {
            display: block;
            /* Lu√¥n hi·ªÉn th·ªã ƒë·ªÉ c√≥ th·ªÉ cu·ªôn t·ªõi */
            padding-top: 20px;
            margin-bottom: 50px;
            /* T·∫°o kho·∫£ng tr·ªëng gi·ªØa c√°c ph·∫ßn */
            min-height: 500px;
            /* ƒê·∫£m b·∫£o m·ªói ph·∫ßn ƒë·ªß cao ƒë·ªÉ tr·∫£i nghi·ªám cu·ªôn t·ªët h∆°n */
        }

        /* Sidebar c·∫ßn fixed ƒë·ªÉ khi cu·ªôn menu kh√¥ng b·ªã tr√¥i m·∫•t */
        .custom-sidebar {
            position: fixed;
            height: 100vh;
            /* ... c√°c thu·ªôc t√≠nh kh√°c gi·ªØ nguy√™n ... */
        }
    </style>
</head>

<body class="main-background">
    <div class="container mt-4 mb-5">
        <div class="custom-sidebar">
            <div class="text-center mb-4">
                <h5 class="fw-bold text-primary">AI VOICE STUDIO</h5>
                <hr class="mx-3 opacity-25">
            </div>

            <div class="sidebar-item active" onclick="switchPage('page-studio', this)">
                <i class="fas fa-microphone-alt"></i> Reference Audio Editor
            </div>

            <div class="sidebar-item" onclick="switchPage('page-editor', this)">
                <i class="fas fa-edit"></i> Configuration & FX
            </div>
        </div>
    </div>


    <div class="col-md-10 main-wrapper" id="page-studio">



        <h2 class="text-center mb-4 fw-bold text-primary">Edge-TTS AI Generator Studio</h2>




        <div class="background-blue p-4 mb-3 border-start border-4 border-warning shadow">
            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-2">
                <h5 class="text-warning m-0">üõ†Ô∏è Reference Audio Editor</h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="ref_display_name" class="badge bg-dark p-2">Ch∆∞a ch·ªçn file</span>
                    <button class="btn btn-sm btn-primary" onclick="uiSelectRefForEditor()">üìÅ Ch·ªçn
                        File</button>
                </div>
            </div>

            <div class="mb-3">
                <audio id="audioRefEditor" controls class="w-100 shadow-sm"
                    style="height: 40px; border-radius: 8px;"></audio>
            </div>

            <div class="row mb-3">
                <div class="col-6">
                    <label class="small fw-bold">Speed: <span id="ref_val_speed" class="label-value">1.0</span>x</label>
                    <input type="range" id="ref_fx_speed" class="form-range" min="0.5" max="2.0" step="0.1" value="1.0"
                        oninput="document.getElementById('ref_val_speed').innerText=this.value">
                </div>
                <div class="col-6">
                    <label class="small fw-bold">Pitch: <span id="ref_val_pitch" class="label-value">0</span>Hz</label>
                    <input type="range" id="ref_fx_pitch" class="form-range" min="-50" max="50" step="1" value="0"
                        oninput="document.getElementById('ref_val_pitch').innerText=this.value">
                </div>
            </div>

            <div class="fx-section">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="small fw-bold">Volume: <span id="ref_val_vol"
                                class="label-value">100</span>%</label>
                        <input type="range" id="ref_fx_vol" class="form-range" min="0" max="150" step="5" value="100"
                            oninput="document.getElementById('ref_val_vol').innerText=this.value">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold">Reverb: <span id="ref_val_reverb"
                                class="label-value">0</span>%</label>
                        <input type="range" id="ref_fx_reverb" class="form-range" min="0" max="100" step="5" value="0"
                            oninput="document.getElementById('ref_val_reverb').innerText=this.value">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="small fw-bold">Bass: <span id="ref_val_bass"
                                class="label-value">0</span>dB</label>
                        <input type="range" id="ref_fx_bass" class="form-range" min="0" max="15" step="1" value="0"
                            oninput="document.getElementById('ref_val_bass').innerText=this.value">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold">Treble: <span id="ref_val_treble"
                                class="label-value">0</span>dB</label>
                        <input type="range" id="ref_fx_treble" class="form-range" min="0" max="15" step="1" value="0"
                            oninput="document.getElementById('ref_val_treble').innerText=this.value">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <label class="small fw-bold">Echo: <span id="ref_val_echo" class="label-value">0</span></label>
                        <input type="range" id="ref_fx_echo" class="form-range" min="0" max="100" step="5" value="0"
                            oninput="document.getElementById('ref_val_echo').innerText=this.value">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold">Chorus: <span id="ref_val_chorus"
                                class="label-value">0</span></label>
                        <input type="range" id="ref_fx_chorus" class="form-range" min="0" max="100" step="5" value="0"
                            oninput="document.getElementById('ref_val_chorus').innerText=this.value">
                    </div>
                </div>

                <div class="row mb-3 p-2 rounded bg-light border mx-0">
                    <div class="col-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ref_fx_compressor">
                            <label class="form-check-label small fw-bold">Comp</label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ref_fx_desser">
                            <label class="form-check-label small fw-bold">Desser</label>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="ref_fx_limiter" checked>
                            <label class="form-check-label small fw-bold">Limiter</label>
                        </div>
                    </div>
                </div>

                <div class="row mb-3 p-2 rounded mx-0" style="background: #f8f9fa; border: 1px dashed #dee2e6;">
                    <div class="col-6">
                        <label class="small fw-bold text-danger">Saturation: <span id="ref_val_drive">0</span></label>
                        <input type="range" id="ref_fx_drive" class="form-range" min="0" max="10" step="0.5" value="0"
                            oninput="document.getElementById('ref_val_drive').innerText=this.value">
                    </div>
                    <div class="col-6">
                        <label class="small fw-bold text-danger">High-Pass: <span id="ref_val_hp">20</span>Hz</label>
                        <input type="range" id="ref_fx_hp" class="form-range" min="20" max="250" step="10" value="20"
                            oninput="document.getElementById('ref_val_hp').innerText=this.value">
                    </div>
                </div>

                <button class="btn btn-warning w-100 fw-bold shadow-sm" onclick="applyRefEditorFX(event)">
                    Save The Setting
                </button>
            </div>
        </div>





        <div class="row">
            <div class="col-md-5" id="page-editor">
                <div class="background-blue p-4 sticky-preview">
                    <h5 class="text-primary border-bottom pb-2 mb-3">Configuration & FX</h5>

                    <div class="mb-3 p-2 bg-light rounded border">
                        <label class="form-label fw-bold small">Folder Presets:</label>
                        <div id="presetContainer" class="d-flex flex-wrap gap-1 mb-2">
                        </div>
                        <button class="btn btn-sm btn-outline-success w-100" onclick="savePreset()">
                            üíæ Save Current FX to Folder
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold small">Search & Select Voice:</label>
                        <input type="text" id="voiceSearch"
                            class="form-control form-control-sm mb-2 border-primary shadow-sm"
                            placeholder="Type to search..." onkeyup="filterVoices()">
                        <select id="globalVoiceSelect" class="form-select shadow-sm border-primary">
                            <option value="">Loading voices...</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="small fw-bold">Speed: <span id="val_speed"
                                    class="label-value">1.0</span>x</label>
                            <input type="range" id="fx_speed" class="form-range" min="0.5" max="2.0" step="0.1"
                                value="1.0" oninput="document.getElementById('val_speed').innerText=this.value">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold">Pitch: <span id="val_pitch"
                                    class="label-value">0</span>Hz</label>
                            <input type="range" id="fx_pitch" class="form-range" min="-50" max="50" step="1" value="0"
                                oninput="document.getElementById('val_pitch').innerText=this.value">
                        </div>
                    </div>

                    <div class="fx-section">
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="small fw-bold">Volume: <span id="val_vol"
                                        class="label-value">100</span>%</label>
                                <input type="range" id="fx_vol" class="form-range" min="0" max="150" step="5"
                                    value="100" oninput="document.getElementById('val_vol').innerText=this.value">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">Reverb: <span id="val_reverb"
                                        class="label-value">0</span>%</label>
                                <input type="range" id="fx_reverb" class="form-range" min="0" max="100" step="5"
                                    value="0" oninput="document.getElementById('val_reverb').innerText=this.value">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="small fw-bold">Bass: <span id="val_bass"
                                        class="label-value">0</span>dB</label>
                                <input type="range" id="fx_bass" class="form-range" min="0" max="15" step="1" value="0"
                                    oninput="document.getElementById('val_bass').innerText=this.value">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">Treble: <span id="val_treble"
                                        class="label-value">0</span>dB</label>
                                <input type="range" id="fx_treble" class="form-range" min="0" max="15" step="1"
                                    value="0" oninput="document.getElementById('val_treble').innerText=this.value">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="small fw-bold">Echo: <span id="val_echo"
                                        class="label-value">0</span></label>
                                <input type="range" id="fx_echo" class="form-range" min="0" max="100" step="5" value="0"
                                    oninput="document.getElementById('val_echo').innerText=this.value">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">Chorus: <span id="val_chorus"
                                        class="label-value">0</span></label>
                                <input type="range" id="fx_chorus" class="form-range" min="0" max="100" step="5"
                                    value="0" oninput="document.getElementById('val_chorus').innerText=this.value">
                            </div>
                        </div>
                        <div class="row mb-3 p-2 rounded bg-light border">
                            <div class="col-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="fx_compressor">
                                    <label class="form-check-label small fw-bold">Comp</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="fx_desser">
                                    <label class="form-check-label small fw-bold">Desser</label>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="fx_limiter" checked>
                                    <label class="form-check-label small fw-bold">Limiter</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3 p-2 rounded" style="background: #f8f9fa; border: 1px dashed #dee2e6;">
                            <div class="col-6">
                                <label class="small fw-bold text-danger">Saturation: <span
                                        id="val_drive">0</span></label>
                                <input type="range" id="fx_drive" class="form-range" min="0" max="10" step="0.5"
                                    value="0" oninput="document.getElementById('val_drive').innerText=this.value">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold text-danger">High-Pass: <span
                                        id="val_hp">20</span>Hz</label>
                                <input type="range" id="fx_hp" class="form-range" min="20" max="250" step="10"
                                    value="20" oninput="document.getElementById('val_hp').innerText=this.value">
                            </div>
                        </div>
                    </div>

                    <hr>
                    <div class="input-group mb-2">
                        <input type="text" id="previewText" class="form-control form-control-sm"
                            placeholder="Test sentence...">
                        <button class="btn btn-sm btn-outline-primary" onclick="previewVoice()">Preview</button>
                    </div>
                    <audio id="audioPreview" controls class="w-100 mt-2"></audio>
                    <div id="audioStatus" class="small text-center mt-1 text-muted">Ready</div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="background-blue p-4 mb-3">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h5 class="text-success m-0">2. Text Processing & Voice Cloning</h5>
                        <div class="d-flex align-items-center gap-2">
                            <span id="currentRefBadge" class="badge bg-dark small">No Voice Selected</span>
                            <button class="btn btn-sm btn-outline-primary" onclick="uiSelectReference()">Select
                                Sample
                                Voice</button>
                        </div>
                    </div>

                    <textarea class="form-control mb-3 shadow-sm" id="InputText" rows="6"
                        placeholder="Paste your text here..."></textarea>

                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-success flex-grow-1 fw-bold" onclick="splitParagraphs()">SPLIT</button>
                        <button id="btnGenerateAll" class="btn btn-primary fw-bold" onclick="generateAll()"
                            disabled>GENERATE ALL</button>
                        <button id="btnCloneAll" class="btn btn-warning fw-bold text-white" onclick="cloneAll()"
                            disabled>CLONE ALL</button>
                        <button id="btnPlayAll" class="btn btn-warning fw-bold text-white" onclick="playAll()"
                            disabled>PLAY ALL</button>
                        <button id="btnSaveAll" class="btn btn-info fw-bold text-white" onclick="saveAll()"
                            disabled>SAVE ALL</button>
                    </div>
                </div>

                <div id="content" class="mt-3"></div>
            </div>
        </div>


    </div>

    <script>
        let paragraphList = [];
        let allVoicesData = [];
        let currentPlayingIndex = -1;
        let isAutoPlaying = false;

        window.onload = async function () {
            try {
                // Load Voices
                allVoicesData = await eel.get_all_voices()();
                allVoicesData.sort((a, b) => a.Locale.localeCompare(b.Locale));
                renderVoiceList(allVoicesData);

                // Load Presets t·ª´ Folder
                renderPresets();

            } catch (e) { console.error("Init Error:", e); }

            document.getElementById('audioPreview').onended = function () {
                if (isAutoPlaying) playNext();
            };
        };

        // --- QU·∫¢N L√ù PRESET ---
        async function renderPresets() {
            const container = document.getElementById('presetContainer');
            const presets = await eel.get_all_presets()();
            container.innerHTML = "";

            Object.keys(presets).forEach(name => {
                const badge = document.createElement('span');
                badge.className = "badge bg-info preset-badge p-2 d-flex align-items-center";
                badge.innerHTML = `
                    <span onclick='applyPresetData(${JSON.stringify(presets[name])})'>${name}</span>
                    <i class="ms-2 text-danger fw-bold" style="font-style:normal;" onclick="deletePreset('${name}')">‚úï</i>
                `;
                container.appendChild(badge);
            });
        }

        async function savePreset() {
            const name = prompt("Enter preset name (to save as .json file):");
            if (!name) return;

            const params = getFXParams();
            // L∆∞u k√®m c·∫£ voice hi·ªán t·∫°i ƒëang ch·ªçn
            params.voiceId = document.getElementById('globalVoiceSelect').value;

            const success = await eel.save_preset_to_file(name, params)();
            if (success) {
                renderPresets();
            }
        }

        async function deletePreset(name) {
            if (!confirm(`Delete preset file "${name}.json"?`)) return;
            await eel.delete_preset_file(name)();
            renderPresets();
        }

        function applyPresetData(p) {
            const setVal = (id, val, isCheck = false) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (isCheck) el.checked = val;
                else el.value = val;
            };

            setVal('fx_speed', p.speed);
            setVal('fx_pitch', p.pitch);
            setVal('fx_vol', p.vol);
            setVal('fx_reverb', p.reverb);
            setVal('fx_bass', p.bass);
            setVal('fx_treble', p.treble);
            setVal('fx_echo', p.echo);
            setVal('fx_chorus', p.chorus);
            setVal('fx_compressor', p.useComp, true);
            setVal('fx_desser', p.useDesser, true);
            setVal('fx_limiter', p.useLimiter, true);
            setVal('fx_drive', p.drive);
            setVal('fx_hp', p.hp_freq);
            if (p.voiceId) document.getElementById('globalVoiceSelect').value = p.voiceId;

            // Update UI labels
            document.querySelectorAll('.label-value').forEach(span => {
                const inputId = span.id.replace('val_', 'fx_');
                const input = document.getElementById(inputId);
                if (input) span.innerText = input.value;
            });
            document.getElementById('val_drive').innerText = p.drive;
            document.getElementById('val_hp').innerText = p.hp_freq;

            alert("Preset applied!");
        }

        // --- LOGIC C≈® ---
        function renderVoiceList(voices) {
            const select = document.getElementById('globalVoiceSelect');
            select.innerHTML = "";
            voices.forEach(v => {
                const option = document.createElement('option');
                option.value = v.ShortName;
                option.text = `[${v.Locale}] ${v.FriendlyName}`;
                if (v.ShortName.includes("HoaiNinh")) option.selected = true;
                select.appendChild(option);
            });
        }

        function filterVoices() {
            const kw = document.getElementById('voiceSearch').value.toLowerCase();
            const filtered = allVoicesData.filter(v => v.FriendlyName.toLowerCase().includes(kw) || v.ShortName.toLowerCase().includes(kw));
            renderVoiceList(filtered);
        }

        function getFXParams() {
            const safeGet = (id, def = 0) => document.getElementById(id) ? document.getElementById(id).value : def;
            const safeCheck = (id) => document.getElementById(id) ? document.getElementById(id).checked : false;

            return {
                speed: safeGet('fx_speed', 1.0),
                pitch: safeGet('fx_pitch', 0),
                vol: safeGet('fx_vol', 100),
                reverb: safeGet('fx_reverb', 0),
                bass: safeGet('fx_bass', 0),
                treble: safeGet('fx_treble', 0),
                useComp: safeCheck('fx_compressor'),
                echo: safeGet('fx_echo', 0),
                chorus: safeGet('fx_chorus', 0),
                useLimiter: safeCheck('fx_limiter'),
                ps: safeGet('fx_pitch', 0),
                wide: 0,
                drive: safeGet('fx_drive', 0),
                hp_freq: safeGet('fx_hp', 20),
                useDesser: safeCheck('fx_desser')
            };
        }

        function getGreetingText(voiceId) {
            const selectedVoice = allVoicesData.find(v => v.ShortName === voiceId);
            if (!selectedVoice) return "Ch√†o b·∫°n.";

            const locale = selectedVoice.Locale;

            const greetingMap = {
                'vi-VN': "Xin ch√†o, ƒë√¢y l√† √¢m thanh nghe th·ª≠ ti·∫øng Vi·ªát.",
                'en-US': "Hello, this is a preview of the American English voice.",
                'en-GB': "Hello, this is a preview of the British English voice.",
                'zh-CN': "‰Ω†Â•ΩÔºåËøôÊòØ‰∏≠ÊñáËØ≠Èü≥È¢ÑËßà„ÄÇ",
                'ja-JP': "„Åì„Çì„Å´„Å°„ÅØ„ÄÅ„Åì„Çå„ÅØÊó•Êú¨Ë™û„ÅÆÈü≥Â£∞„Éó„É¨„Éì„É•„Éº„Åß„Åô„ÄÇ",
                'ko-KR': "ÏïàÎÖïÌïòÏÑ∏Ïöî, Ïù¥Í≤ÉÏùÄ ÌïúÍµ≠Ïñ¥ ÏùåÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞ÏûÖÎãàÎã§.",
                'fr-FR': "Bonjour, ƒë√¢y l√† √¢m thanh nghe th·ª≠ ti·∫øng Ph√°p."
            };

            return greetingMap[locale] || "Hello, this is a preview of the selected voice.";
        }

        async function previewVoice() {
            const voiceId = document.getElementById('globalVoiceSelect').value;

            let text = document.getElementById('previewText').value;
            if (!text.trim()) {
                text = getGreetingText(voiceId);
            }

            const p = getFXParams();

            let url = await eel.process_preview(
                text, voiceId, p.speed, p.pitch, p.vol,
                p.reverb, p.bass, p.treble, p.useComp,
                p.echo, p.chorus, p.useLimiter, p.ps,
                p.wide, p.drive, p.hp_freq, p.useDesser
            )();

            if (url) {
                const audio = document.getElementById('audioPreview');
                audio.src = url + "?t=" + new Date().getTime();
                audio.play();
            }
        }

        // --- PH·∫¶N S·ª¨A ƒê·ªîI CH√çNH TRONG H√ÄM GENERATE SINGLE ---
        async function generateSingle(index) {
            const text = paragraphList[index];
            const statusLabel = document.getElementById(`gen_status_${index}`);

            // Thu th·∫≠p VoiceId ri√™ng c·ªßa d√≤ng ƒë√≥
            const voiceId = document.getElementById(`l_voice_select_${index}`).value;

            // H√†m l·∫•y gi√° tr·ªã t·ª´ c√°c slider/checkbox c·ªßa ri√™ng d√≤ng n√†y
            const getLVal = (id) => document.getElementById(`l_fx_${id}_${index}`).value;
            const getLCheck = (id) => document.getElementById(`l_fx_${id}_${index}`).checked;

            // Thu th·∫≠p to√†n b·ªô tham s·ªë FX local
            const p = {
                speed: getLVal('speed'),
                pitch: getLVal('pitch'),
                vol: getLVal('vol'),
                reverb: getLVal('reverb'),
                bass: getLVal('bass'),
                treble: getLVal('treble'),
                echo: getLVal('echo'),
                chorus: getLVal('chorus'),
                useComp: getLCheck('compressor'),
                useDesser: getLCheck('desser'),
                useLimiter: getLCheck('limiter'),
                drive: getLVal('drive'),
                hp_freq: getLVal('hp')
            };

            statusLabel.innerText = "‚ö° ƒêang x·ª≠ l√Ω...";
            statusLabel.classList.remove('text-muted');
            statusLabel.classList.add('text-primary');

            // G·ªçi Python v·ªõi ƒë·∫ßy ƒë·ªß b·ªô tham s·ªë ri√™ng bi·ªát cho t·ª´ng ƒëo·∫°n
            let success = await eel.process_ai_generate_with_fx(
                text,
                voiceId,
                index,
                p.speed,
                p.pitch,
                p.vol,
                p.reverb,
                p.bass,
                p.treble,
                p.useComp,
                p.echo,
                p.chorus,
                p.useLimiter,
                p.pitch, // Tham s·ªë 'ps' (pitch shift b·ªï sung) l·∫•y b·∫±ng pitch lu√¥n
                0,       // wide
                p.drive,
                p.hp_freq,
                p.useDesser
            )();

            if (success) {
                statusLabel.innerText = "‚úÖ Ho√†n t·∫•t";
                statusLabel.className = "small d-block mb-1 text-success fw-bold";
                document.getElementById(`btn_play_${index}`).disabled = false;
                document.getElementById(`btn_save_${index}`).disabled = false;
                document.getElementById(`btn_clone_${index}`).disabled = false;
                checkPlayAllStatus();
            } else {
                statusLabel.innerText = "‚ùå L·ªói x·ª≠ l√Ω";
                statusLabel.className = "small d-block mb-1 text-danger";
            }
        }

        // H√†m b·ªï sung ƒë·ªÉ ƒë·ªìng b·ªô nh√£n text hi·ªÉn th·ªã tr√™n slider local (tr√°nh b·ªã ƒë·ª©ng s·ªë)
        function updateLocalLabel(index, type, val) {
            const label = document.getElementById(`l_val_${type}_${index}`);
            if (label) label.innerText = val;
        }

        async function generateAll() {
            const btn = document.getElementById('btnGenerateAll');
            btn.disabled = true;
            btn.innerText = "PROCESSING...";
            for (let i = 0; i < paragraphList.length; i++) {
                await generateSingle(i);
            }
            btn.disabled = false;
            btn.innerText = "GENERATE ALL";
        }

        function checkPlayAllStatus() {
            document.getElementById('btnPlayAll').disabled = false;
            document.getElementById('btnSaveAll').disabled = false;
            document.getElementById('btnCloneAll').disabled = false;
        }

        function splitParagraphs() {
            const text = document.getElementById('InputText').value;
            if (!text.trim()) return;
            paragraphList = text.split('\n').filter(l => l.trim() !== "");
            renderUI();
            document.getElementById('btnGenerateAll').disabled = false;
        }

        async function renderUI() {
            const container = document.getElementById('content');
            container.innerHTML = "<div class='text-center'>ƒêang chu·∫©n b·ªã danh s√°ch...</div>";

            const presets = await eel.get_all_presets()();
            const presetNames = Object.keys(presets);

            const mainVoiceSelect = document.getElementById('globalVoiceSelect');
            const voiceOptionsHtml = mainVoiceSelect ? mainVoiceSelect.innerHTML : "";
            const currentGlobalVoice = mainVoiceSelect ? mainVoiceSelect.value : "";

            container.innerHTML = "";
            paragraphList.forEach((p, index) => {
                const item = document.createElement('div');
                item.className = "background-blue p-3 mb-3 shadow-sm rounded border";
                item.id = `row_${index}`;

                let presetOptions = `<option value="CUSTOM">-- T√πy ch·ªânh (Custom) --</option>`;
                presetNames.forEach(name => {
                    presetOptions += `<option value='${JSON.stringify(presets[name])}'>Preset: ${name}</option>`;
                });

                item.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <p class="mb-2 fw-bold text-dark">${p}</p>
                            <div class="d-flex align-items-center gap-2">
                                <select id="preset_select_${index}" class="form-select form-select-sm" style="max-width: 160px;" onchange="handlePresetChange(${index}, this.value)">
                                    ${presetOptions}
                                </select>
                                <select id="l_voice_select_${index}" class="form-select form-select-sm" style="max-width: 150px;" onchange="markAsCustom(${index})">
                                    ${voiceOptionsHtml}
                                </select>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#fx_collapse_${index}">‚öôÔ∏è FX</button>
                            </div>
                        </div>
                        <div class="col-md-5 text-end">
                            <span id="gen_status_${index}" class="small d-block mb-1 text-muted">S·∫µn s√†ng</span>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-primary" onclick="generateSingle(${index})">Generate</button>
                                
                                <button id="btn_clone_${index}" class="btn btn-sm btn-dark" onclick="convertSegmentToClone(${index})" disabled>üë§ Clone</button>
                                
                                <button id="btn_play_${index}" class="btn btn-sm btn-success" onclick="manualPlay(${index})" disabled>Play</button>
                                <button class="btn btn-sm btn-info text-white" id="btn_save_${index}" onclick="saveSingle(${index})" disabled>Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="collapse" id="fx_collapse_${index}">

                        <div class="fx-details p-3 mt-2 border-primary border-start border-4 bg-white" onchange="markAsCustom(${index})">

                            <div class="row mb-3">

                                <div class="col-3">

                                    <label class="small fw-bold">Speed: <span class="text-primary" id="l_val_speed_${index}">1.0</span></label>

                                    <input type="range" id="l_fx_speed_${index}" class="form-range" min="0.5" max="2.0" step="0.1" value="1.0" oninput="document.getElementById('l_val_speed_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Pitch: <span class="text-primary" id="l_val_pitch_${index}">0</span></label>

                                    <input type="range" id="l_fx_pitch_${index}" class="form-range" min="-50" max="50" step="1" value="0" oninput="document.getElementById('l_val_pitch_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Vol: <span class="text-primary" id="l_val_vol_${index}">100</span></label>

                                    <input type="range" id="l_fx_vol_${index}" class="form-range" min="0" max="150" step="5" value="100" oninput="document.getElementById('l_val_vol_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Reverb: <span class="text-primary" id="l_val_reverb_${index}">0</span></label>

                                    <input type="range" id="l_fx_reverb_${index}" class="form-range" min="0" max="100" step="5" value="0" oninput="document.getElementById('l_val_reverb_${index}').innerText=this.value">

                                </div>

                            </div>

                            <div class="row mb-3">

                                <div class="col-3">

                                    <label class="small fw-bold">Bass: <span class="text-primary" id="l_val_bass_${index}">0</span></label>

                                    <input type="range" id="l_fx_bass_${index}" class="form-range" min="0" max="15" step="1" value="0" oninput="document.getElementById('l_val_bass_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Treble: <span class="text-primary" id="l_val_treble_${index}">0</span></label>

                                    <input type="range" id="l_fx_treble_${index}" class="form-range" min="0" max="15" step="1" value="0" oninput="document.getElementById('l_val_treble_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Echo: <span class="text-primary" id="l_val_echo_${index}">0</span></label>

                                    <input type="range" id="l_fx_echo_${index}" class="form-range" min="0" max="100" step="5" value="0" oninput="document.getElementById('l_val_echo_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold">Chorus: <span class="text-primary" id="l_val_chorus_${index}">0</span></label>

                                    <input type="range" id="l_fx_chorus_${index}" class="form-range" min="0" max="100" step="5" value="0" oninput="document.getElementById('l_val_chorus_${index}').innerText=this.value">

                                </div>

                            </div>

                            <div class="row align-items-center">

                                <div class="col-2"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="l_fx_compressor_${index}"><label class="small">Comp</label></div></div>

                                <div class="col-2"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="l_fx_desser_${index}"><label class="small">Desser</label></div></div>

                                <div class="col-2"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="l_fx_limiter_${index}" checked><label class="small">Limit</label></div></div>

                                <div class="col-3">

                                    <label class="small fw-bold text-danger">Drive: <span id="l_val_drive_${index}">0</span></label>

                                    <input type="range" id="l_fx_drive_${index}" class="form-range" min="0" max="10" step="0.5" value="0" oninput="document.getElementById('l_val_drive_${index}').innerText=this.value">

                                </div>

                                <div class="col-3">

                                    <label class="small fw-bold text-danger">HP: <span id="l_val_hp_${index}">20</span>Hz</label>

                                    <input type="range" id="l_fx_hp_${index}" class="form-range" min="20" max="250" step="10" value="20" oninput="document.getElementById('l_val_hp_${index}').innerText=this.value">

                                </div>

                            </div>

                        </div>

                    </div>`;

                container.appendChild(item);
                document.getElementById(`l_voice_select_${index}`).value = currentGlobalVoice;
                syncLocalFXWithGlobal(index);
            });
        }

        // H√†m copy to√†n b·ªô th√¥ng s·ªë t·ª´ Panel tr√°i sang ƒëo·∫°n vƒÉn c·ª• th·ªÉ
        function syncLocalFXWithGlobal(index) {
            const p = getFXParams(); // L·∫•y th√¥ng s·ªë hi·ªán t·∫°i c·ªßa panel tr√°i
            applyParamsToRow(index, p);
        }

        // H√†m x·ª≠ l√Ω khi ch·ªçn Preset trong Dropdown c·ªßa t·ª´ng d√≤ng
        function handlePresetChange(index, jsonValue) {
            if (jsonValue === "CUSTOM") {
                // N·∫øu ch·ªçn CUSTOM, gi·ªØ nguy√™n th√¥ng s·ªë hi·ªán t·∫°i c·ªßa d√≤ng ƒë√≥
                return;
            }
            const p = JSON.parse(jsonValue);
            applyParamsToRow(index, p);
        }

        // H√†m ph·ª• ƒë·ªÉ √°p d·ª•ng object params v√†o UI c·ªßa d√≤ng
        function applyParamsToRow(index, p) {
            const localVoiceSelect = document.getElementById(`l_voice_select_${index}`);

            // √Åp d·ª•ng Voice n·∫øu c√≥ trong params (t·ª´ Preset)
            if (p.voiceId && localVoiceSelect) {
                localVoiceSelect.value = p.voiceId;
            }

            // C·∫≠p nh·∫≠t c√°c Sliders
            const sliders = ['speed', 'pitch', 'vol', 'reverb', 'bass', 'treble', 'echo', 'chorus', 'drive', 'hp'];
            sliders.forEach(f => {
                const val = (f === 'hp') ? (p.hp_freq || 20) : p[f];
                const input = document.getElementById(`l_fx_${f}_${index}`);
                const label = document.getElementById(`l_val_${f}_${index}`);
                if (input && val !== undefined) {
                    input.value = val;
                    if (label) label.innerText = val;
                }
            });

            // C·∫≠p nh·∫≠t Checkboxes
            const checks = { 'compressor': p.useComp, 'desser': p.useDesser, 'limiter': p.useLimiter };
            Object.keys(checks).forEach(key => {
                const el = document.getElementById(`l_fx_${key}_${index}`);
                if (el && checks[key] !== undefined) el.checked = !!checks[key];
            });
        }

        function markAsCustom(index) {
            const select = document.getElementById(`preset_select_${index}`);
            if (select) {
                select.value = "CUSTOM";
            }
        }




        // 1. N√∫t Play c·ªßa t·ª´ng d√≤ng s·∫Ω g·ªçi h√†m n√†y
        function manualPlay(index) {
            isAutoPlaying = false;
            play_gen(index);
        }

        // 2. H√†m l√µi ƒëi·ªÅu khi·ªÉn th·∫ª Audio
        function play_gen(index) {
            // UI: Highlight d√≤ng ƒëang ph√°t
            document.querySelectorAll('.background-blue').forEach(el => el.classList.remove('playing-now'));
            currentPlayingIndex = index;

            const audio = document.getElementById('audioPreview');
            const row = document.getElementById(`row_${index}`);
            if (row) row.classList.add('playing-now');

            // KI·ªÇM TRA FILE: ∆Øu ti√™n Cloned -> G·ªëc
            const statusLabel = document.getElementById(`gen_status_${index}`);
            let fileName = `gen_${index}.wav`; // M·∫∑c ƒë·ªãnh l√† file g·ªëc

            // N·∫øu nh√£n c√≥ ch·ªØ "Cloned", ƒë·ªïi sang file clone
            if (statusLabel && statusLabel.innerText.includes("Cloned")) {
                fileName = `gen_${index}_cloned.wav`;
            }

            // G√°n ngu·ªìn ph√°t k√®m Timestamp ƒë·ªÉ x√≥a cache tr√¨nh duy·ªát
            const finalUrl = `temp_edit/${fileName}?t=${new Date().getTime()}`;
            console.log("Playing:", finalUrl);

            audio.src = finalUrl;
            audio.load(); // Bu·ªôc tr√¨nh duy·ªát n·∫°p l·∫°i file m·ªõi

            audio.play().catch(e => {
                console.error("Playback error:", e);
                // N·∫øu file kh√¥ng t·ªìn t·∫°i ho·∫∑c l·ªói, t·ª± ƒë·ªông chuy·ªÉn c√¢u n·∫øu ƒëang Play All
                if (isAutoPlaying) playNext();
            });
        }

        function playAll() {
            if (paragraphList.length === 0) return;
            isAutoPlaying = true;
            play_gen(0);
        }

        function playNext() {
            let nextIndex = currentPlayingIndex + 1;

            if (nextIndex < paragraphList.length) {
                const nextBtn = document.getElementById(`btn_play_${nextIndex}`);

                // Ch·ªâ ph√°t n·∫øu n√∫t Play kh√¥ng b·ªã disabled (ƒë√£ generate xong)
                if (nextBtn && !nextBtn.disabled) {
                    play_gen(nextIndex);
                } else {
                    // N·∫øu ƒëo·∫°n n√†y ch∆∞a c√≥ audio, t·ª± ƒë·ªông b·ªè qua t√¨m ƒëo·∫°n ti·∫øp theo
                    currentPlayingIndex = nextIndex;
                    playNext();
                }
            } else {
                // K·∫øt th√∫c danh s√°ch ph√°t
                isAutoPlaying = false;
                document.querySelectorAll('.background-blue').forEach(el => el.classList.remove('playing-now'));
                alert("Finished playing all segments!");
            }
        }

        async function saveSingle(index) {
            // 1. L·∫•y ph·∫ßn t·ª≠ select preset c·ªßa d√≤ng n√†y
            const presetSelect = document.getElementById(`preset_select_${index}`);
            let selectedPresetName = "";

            if (presetSelect) {
                // L·∫•y text hi·ªÉn th·ªã (v√≠ d·ª•: "Preset: GiongNam") thay v√¨ gi√° tr·ªã JSON
                const selectedText = presetSelect.options[presetSelect.selectedIndex].text;

                // Lo·∫°i b·ªè ch·ªØ "Preset: " ƒë·ªÉ l·∫•y t√™n s·∫°ch
                selectedPresetName = selectedText.replace("Preset: ", "").trim();

                // N·∫øu ƒëang ch·ªçn "T√πy ch·ªânh", g√°n t√™n l√† Custom
                if (selectedPresetName.includes("-- T√πy ch·ªânh")) {
                    selectedPresetName = "Custom";
                }
            }

            // 2. G·ªçi h√†m Python v·ªõi 2 tham s·ªë: index v√† t√™n preset
            const result = await eel.save_single_audio(index, selectedPresetName)();

            if (result.status === "success") {
                alert(result.message);
            } else if (result.status === "error") {
                alert("L·ªói: " + result.message);
            }
        }

        async function saveAll() {
            if (paragraphList.length === 0) return;

            // Thu th·∫≠p danh s√°ch t√™n Preset t·ª´ c√°c d√≤ng ƒë·ªÉ ƒë·∫∑t t√™n file
            let presetNames = [];
            for (let i = 0; i < paragraphList.length; i++) {
                const select = document.getElementById(`preset_select_${i}`);
                let name = "Custom";
                if (select) {
                    const selectedText = select.options[select.selectedIndex].text;
                    name = selectedText.replace("Preset: ", "").trim();
                    if (name.includes("-- T√πy ch·ªânh")) name = "Custom";
                }
                presetNames.push(name);
            }

            const btn = document.getElementById('btnSaveAll');
            btn.innerText = "SAVING...";
            btn.disabled = true;

            const result = await eel.save_all_audio(paragraphList, presetNames)();

            if (result.status === "success") {
                alert(result.message);
            } else if (result.status === "error") {
                alert("L·ªói: " + result.message);
            }

            btn.innerText = "SAVE ALL";
            btn.disabled = false;
        }


        // --- LOGIC VOICE CLONING ---

        async function uiSelectReference() {
            const result = await eel.select_reference_audio()();
            if (result.status === "success") {
                const badge = document.getElementById('currentRefBadge');
                badge.innerText = "Gi·ªçng m·∫´u: " + result.file_name;
                badge.className = "badge bg-primary p-2"; // ƒê·ªïi m√†u xanh khi ƒë√£ c√≥ file
            }
        }

        async function uiLearnVoice() {
            const status = document.getElementById('cloneStatus');
            status.innerText = "‚è≥ ƒêang tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng gi·ªçng n√≥i...";
            // Th·ª±c t·∫ø h√†m select_reference_audio ƒë√£ bao g·ªìm b∆∞·ªõc h·ªçc (tr√≠ch xu·∫•t SE)
            alert("H·ªá th·ªëng ƒë√£ s·∫µn s√†ng d√πng gi·ªçng m·∫´u n√†y!");
        }

        // H√†m b·ªï tr·ª£ ƒë·ªÉ ƒë·ªïi m√†u row khi ph√°t file clone
        function manualPlayWithSrc(index, src) {
            document.querySelectorAll('.background-blue').forEach(el => el.classList.remove('playing-now'));
            document.getElementById(`row_${index}`).classList.add('playing-now');
            const audio = document.getElementById('audioPreview');
            audio.src = src;
            audio.play();
        }

        // H√†m m·ªü th∆∞ m·ª•c ch·ª©a file m·∫´u (Optional)
        function openUsedFolder() {
            eel.open_folder("processed")(); // B·∫°n c·∫ßn vi·∫øt th√™m h√†m n√†y ·ªü Python n·∫øu mu·ªën
        }

        // Bi·∫øn l∆∞u t√™n file hi·ªán t·∫°i c·ªßa editor
        let currentRefFile = "";

        async function uiSelectRefForEditor() {
            const result = await eel.select_reference_audio()();
            if (result.status === "success") {
                currentRefFile = result.file_name;
                document.getElementById('ref_display_name').innerText = currentRefFile;

                const player = document.getElementById('audioRefEditor');
                const timestamp = new Date().getTime();

                // N·∫°p file t·ª´ th∆∞ m·ª•c processed
                player.src = `processed/${currentRefFile}?t=${timestamp}`;
                player.load();

                // T·ª± ƒë·ªông ph√°t ƒë·ªÉ ki·ªÉm tra file ƒë√£ ch·ªçn
                player.oncanplaythrough = () => {
                    player.play().catch(e => console.log("Nh·∫•n ph√°t th·ªß c√¥ng"));
                };
            }
        }

        async function applyRefEditorFX(event) { // Th√™m tham s·ªë event ƒë·ªÉ tr√°nh l·ªói
            if (!currentRefFile) {
                alert("Vui l√≤ng ch·ªçn file m·∫´u!");
                return;
            }

            const data = {
                file_name: currentRefFile,
                // C√°c th√¥ng s·ªë FX gi·ªØ nguy√™n...
                speed: document.getElementById('ref_fx_speed').value,
                pitch: document.getElementById('ref_fx_pitch').value,
                vol: document.getElementById('ref_fx_vol').value,
                reverb: document.getElementById('ref_fx_reverb').value,
                bass: document.getElementById('ref_fx_bass').value,
                treble: document.getElementById('ref_fx_treble').value,
                echo: document.getElementById('ref_fx_echo').value,
                chorus: document.getElementById('ref_fx_chorus').value,
                comp: document.getElementById('ref_fx_compressor').checked,
                desser: document.getElementById('ref_fx_desser').checked,
                limit: document.getElementById('ref_fx_limiter').checked,
                drive: document.getElementById('ref_fx_drive').value,
                hp: document.getElementById('ref_fx_hp').value
            };

            const btn = event.currentTarget;
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Wait For Save...';

            try {
                const res = await eel.process_and_save_to_used(data)();

                if (res.status === "success") {
                    currentRefFile = res.file_name;

                    const player = document.getElementById('audioRefEditor');
                    const timestamp = new Date().getTime();

                    player.src = `used/${currentRefFile}?t=${timestamp}`;
                    player.load();
                    player.play();

                    const displayLabel = document.getElementById('ref_display_name');
                    if (displayLabel) {
                        displayLabel.innerText = currentRefFile;
                        displayLabel.className = "badge bg-success p-2 animate__animated animate__bounceIn";
                    }

                    alert("Save Succeed: " + currentRefFile);

                } else if (res.status === "cancel") {
                    console.log("Save Cancelled.");
                }
            } catch (err) {
                alert("Error Connecting To Python: " + err);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        function playRefAudio() {
            const player = document.getElementById('audioPreview');

            if (!refEditorFile) {
                alert("Please select a reference file!");
                return;
            }

            player.play().catch(err => {
                console.log("Play Failed...");
                const timestamp = new Date().getTime();
                player.src = `processed/${refEditorFile}?t=${timestamp}`;
                player.play();
            });
        }

        function switchPage(pageId, element) {
            const targetElement = document.getElementById(pageId);

            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                element.classList.add('active');
            }
        }

        async function cloneAll() {
            const btn = document.getElementById('btnCloneAll');
            if (paragraphList.length === 0) return;

            btn.disabled = true;
            btn.innerText = "‚è≥ CLONING...";

            for (let i = 0; i < paragraphList.length; i++) {
                const playBtn = document.getElementById(`btn_play_${i}`);
                if (playBtn && !playBtn.disabled) {
                    await convertSegmentToClone(i);
                    await new Promise(r => setTimeout(r, 1000));
                }
            }

            btn.disabled = false;
            btn.innerText = "DONE ALL";
        }

        async function convertSegmentToClone(index) {
            const statusLabel = document.getElementById(`gen_status_${index}`);
            const playBtn = document.getElementById(`btn_play_${index}`);

            if (statusLabel) statusLabel.innerText = "Cloning...";

            try {
                const result = await eel.convert_to_clone_voice(`temp_edit/gen_${index}.wav`)();

                if (result.status === "success") {
                    if (statusLabel) {
                        statusLabel.innerText = "Cloned";
                        statusLabel.style.color = "green";
                    }
                    if (playBtn) {
                        playBtn.onclick = function () { manualPlay(index); };
                    }
                    return true;
                }
            } catch (e) { console.error(e); }
            return false;
        }




        window.addEventListener('beforeunload', function (e) {
            const confirmationMessage = 'Are You Sure Want To Close? The Unsave Files Will Be Delete.';

            (e || window.event).returnValue = confirmationMessage;
            return confirmationMessage;
        });
    </script>
</body>

</html>